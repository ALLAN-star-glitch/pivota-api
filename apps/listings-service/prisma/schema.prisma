generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

/// =====================================================================
///                            JOB CATEGORIES
/// =====================================================================
model Category {
  id            String   @id @default(cuid())
  externalId    String   @default(uuid())
  
  // NEW: Discriminator for which pillar this belongs to
  vertical      String   // e.g., "JOBS", "HOUSING", "SOCIAL_SUPPORT"
  
  name          String   
  slug          String   // e.g., "plumbing"
  description   String?
  
  // Hierarchy Logic
  parentId      String?
  parent        Category?  @relation("Subcategories", fields: [parentId], references: [id])
  subcategories Category[] @relation("Subcategories")
  
  // Relationships
  jobPosts         JobPost[]          @relation("MainCategory")
  subCategoryPosts JobPost[]          @relation("SubcategoryPosts")
  serviceOfferings ServiceOffering[]
  supportPrograms  SupportProgram[]
  providerPricingRules ProviderPricingRule[]

  hasSubcategories Boolean @default(false)
  hasParent        Boolean @default(false)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@unique([vertical, slug])
  @@index([vertical])
}


/// =====================================================================
///                            JOB POSTS
/// =====================================================================
model JobPost {
  id          String   @id @default(cuid())
  externalId  String   @default(uuid())
  title       String
  description String
  categoryId  String
  category    Category @relation("MainCategory", fields: [categoryId], references: [id])

  subCategoryId  String?
  subCategory    Category? @relation("SubcategoryPosts", fields: [subCategoryId], references: [id])

  creatorId   String
  jobType     String
  locationCity String
  locationNeighborhood String?
  isRemote   Boolean @default(false)

  requiresDocuments Boolean @default(false)
  requiresEquipment Boolean @default(false)

  allowReferrals    Boolean @default(true) 
  referralBonus     Float?  // If the employer is offering money for a successful referral

  // NEW SOURCE OF TRUTH
  isNegotiable    Boolean @default(false)

  payAmount Float?
  payRate   String?
  skills    String[] @default([])
  experienceLevel String?
  employmentType String?
  documentsNeeded String[] @default([])
  equipmentRequired String[] @default([])
  additionalNotes String?
  status String @default("ACTIVE")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applications JobPostApplication[]
  ratings     Rating[]

  @@index([locationCity])
  @@index([status])
  @@index([creatorId]) // Good for "My Posts" dashboard
  @@index([categoryId])
}


/// =====================================================================
///                        JOB POST APPLICATIONS
/// =====================================================================
model JobPostApplication {
  id           String   @id @default(cuid())
  externalId   String   @default(uuid())

  // ======================
  // Relations
  // ======================
  jobPostId    String
  jobPost      JobPost  @relation(fields: [jobPostId], references: [id], onDelete: Cascade)

  applicantId  String   // User ID from Identity Service
  employerId   String   // Denormalized for fast dashboard queries

  // ======================
  // Referral Details
  // ======================
  referrerName         String?
  referrerPhone        String?
  referrerEmail        String? // Kept for Formal Pillar background checks
  referrerRelationship String? // e.g., "Former Manager", "Vouched Colleague"

  // ======================
  // Applicant Intent & Compliance
  // ======================
  expectedPay          Float?
  availabilityDate     DateTime?
  availabilityNotes    String?
  
  // Handshake: Worker confirms they have the tools mentioned in JobPost
  hasRequiredEquipment Boolean @default(false) 

  // ======================
  // Status & Decisioning
  // ======================
  status            String    @default("PENDING") 
  employerNotes     String?
  rejectionReason   String?
  agreedPay         Float?    // The final negotiated rate
  agreedStartDate   DateTime?

  // ======================
  // Lifecycle Timestamps
  // ======================
  reviewedAt   DateTime?
  decidedAt    DateTime?
  startedAt    DateTime?
  completedAt  DateTime?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // ======================
  // Relations
  // ======================
  attachments   JobApplicationAttachment[]
  statusHistory JobApplicationStatusHistory[]

  // ======================
  // Constraints & Indexes
  // ======================
  @@unique([jobPostId, applicantId])
  @@index([applicantId])
  @@index([employerId])
  @@index([jobPostId])
  @@index([status])
  @@index([referrerPhone])
  @@index([referrerEmail]) // Added index for referral lookups
}

model JobApplicationAttachment {
  id             String   @id @default(cuid())
  externalId     String   @default(uuid())

  applicationId  String
  application    JobPostApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  // ======================
  // Document Metadata
  // ======================
  type        String
  /*
    CV
    COVER_LETTER
    ID
    CERTIFICATE
    LICENSE
    PORTFOLIO
    OTHER
  */

  fileUrl     String
  fileName    String?
  mimeType    String?
  fileSize    Int?

  // Optional structured text (important!)
  contentText String?
  /*
    Used when:
    - Cover letter is typed, not uploaded
    - Lightweight informal applications
  */

  isPrimary   Boolean @default(false)
  isRequired  Boolean @default(false)

  createdAt   DateTime @default(now())

  @@index([applicationId])
  @@index([type])
}

model JobApplicationStatusHistory {
  id             String   @id @default(cuid())

  applicationId  String
  application    JobPostApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  oldStatus      String
  newStatus      String
  changedBy      String   // User/Admin/Employer ID
  reason         String?

  createdAt      DateTime @default(now())

  @@index([applicationId])
  @@index([newStatus])
}


/// =====================================================================
///                        PROVIDER SERVICE LISTINGS
/// =====================================================================
/// =====================================================================
///                        PROVIDER SERVICE OFFERINGS (The Storefront)
/// =====================================================================
model ServiceOffering {
  id           String   @id @default(cuid())
  externalId   String   @default(uuid())
  providerId   String   // Reference to User/Provider UUID from Identity Service
  
  title        String   // e.g., "Professional Plumbing & Leak Repair"
  description  String
  
  // Cross-Vertical Tagging
  // Using String[] to act as an array of tags (e.g., ["JOBS", "HOUSING"])
  // This allows one offering to show up in multiple modules.
  verticals    String[] @default(["JOBS"]) 
  
  categoryId   String
  category     Category @relation(fields: [categoryId], references: [id])
  
  // Supply-side pricing logic
  basePrice    Float
  priceUnit    String      @default("FIXED") // e.g., "PER_HOUR", "PER_SQFT", "FIXED"
  
  locationCity         String
  locationNeighborhood String?
  
  // Professional specific fields
  yearsExperience Int?
  isVerified      Boolean  @default(false)
  availability    String?  // Could be a JSON string of working hours
  
  additionalNotes String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relationships
 reviews     Rating[] @relation("ServiceReviews")


  @@index([locationCity])
  @@index([verticals])   // Extremely important for cross-vertical discovery
  @@index([providerId])
  @@index([categoryId])
}

/// =====================================================================
///                            BOOKINGS
/// =====================================================================
model Booking {
  id          String   @id @default(cuid())
  externalId  String   @default(uuid())
  jobPostId   String
  providerId  String    // reference User Service ID
  status      String    @default("PENDING") // was enum
  scheduledDate DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

/// =====================================================================
///                           RATINGS & REVIEWS
/// =====================================================================
model Rating {
  id              String           @id @default(cuid())
  externalId      String           @default(uuid())
  
  // Relation to JobPost (Optional, for employer reviews)
  jobPostId       String?
  jobPost         JobPost?         @relation(fields: [jobPostId], references: [id])

  // Relation to ServiceOffering (Optional, for provider reviews)
  serviceId       String?
  serviceOffering ServiceOffering? @relation("ServiceReviews", fields: [serviceId], references: [id])

  userId          String   // The person writing the review (Reviewer)
  rating          Int      // e.g., 1-5
  review          String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

/// =====================================================================
///                            HOUSING (Asset-Driven)
/// =====================================================================
model HouseListing {
  id           String   @id @default(cuid())
  externalId   String   @default(uuid())
  ownerId      String   // Reference to User/Owner UUID
  
  title        String
  description  String
  type         String   // e.g., "APARTMENT", "HOUSE", "STUDIO"
  listingType  String   // e.g., "RENTAL", "SALE"
  
  price        Float
  currency     String   @default("KES")
  
  // Property details
  bedrooms     Int?
  bathrooms    Int?
  amenities    String[] @default([])
  isFurnished  Boolean  @default(false)
  
  // Location
  locationCity         String
  locationNeighborhood String?
  address              String?
  
  status       String   @default("AVAILABLE") // e.g., AVAILABLE, BOOKED, SOLD
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relationships
  images       HouseImage[]
  viewings     HouseViewing[]


  @@index([locationCity])
  @@index([type])        // e.g. "APARTMENT"
  @@index([listingType]) // e.g. "RENTAL"
  @@index([status])
}

model HouseImage {
  id           String       @id @default(cuid())
  url          String
  isMain       Boolean      @default(false)
  houseId      String
  house        HouseListing @relation(fields: [houseId], references: [id])
}

model HouseViewing {
  id           String       @id @default(cuid())
  houseId      String
  house        HouseListing @relation(fields: [houseId], references: [id])
  viewerId     String       // User ID
  viewingDate  DateTime
  status       String       @default("SCHEDULED")
}

/// =====================================================================
///                       SOCIAL SUPPORT (Impact-Driven)
/// =====================================================================
model SupportProgram {
  id           String   @id @default(cuid())
  externalId   String   @default(uuid())
  organizationId String // Reference to NGO/Gov/Partner UUID
  
  title        String
  description  String
  
  // CHANGED: Linked to the Unified Category system
  categoryId   String
  category     Category @relation(fields: [categoryId], references: [id])
  
  // Programs are often eligibility-based
  eligibilityCriteria String?
  targetAudience      String[] @default([]) // e.g., ["Youth", "Refugees", "Widows"]
  
  // Logistics
  isFree       Boolean  @default(true)
  baseCost     Float?   @default(0) // For subsidized programs
  
  locationCity         String?
  locationNeighborhood String?
  
  // Capacity tracking
  maxBeneficiaries     Int?     // Limit on intake
  currentBeneficiaries Int      @default(0)
  
  status       String   @default("ACTIVE") // ACTIVE, FULL, COMPLETED
  expiresAt    DateTime?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  applications SupportApplication[]

  @@index([locationCity])
  @@index([categoryId])
  @@index([status])
}

model SupportApplication {
  id           String         @id @default(cuid())
  externalId   String         @default(uuid())
  
  programId    String
  program      SupportProgram @relation(fields: [programId], references: [id])
  
  beneficiaryId String        // The User applying for help
  
  // Better status tracking for NGO workflows
  status       String         @default("PENDING") // PENDING, UNDER_REVIEW, APPROVED, REJECTED
  
  userNotes    String?        // Statement of need from the user
  adminNotes   String?        // Internal notes for the NGO
  
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([beneficiaryId])
  @@index([programId])
}

model ProviderPricingRule {
  id                   String   @id @default(uuid())
  vertical             String   
  unit                 String   

  // 1. Replace categorySlug string with categoryId
  categoryId           String?

  // 2. Define the relation with onDelete: Cascade
  // This ensures if a Category is deleted, these rules are also removed automatically.
  category             Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  // ISO 4217 Currency Code (e.g., KES, USD, NGN)
  currency             String   @default("KES")

  minPrice             Float?   @default(0)
  maxPrice             Float?   
  isExperienceRequired Boolean  @default(false)
  isNotesRequired      Boolean  @default(false)
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())

  // 3. Update the unique constraint to use the ID
  @@unique([vertical, unit, currency, categoryId])
}

