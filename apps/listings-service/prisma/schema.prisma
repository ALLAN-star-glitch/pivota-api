generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

/// =====================================================================
///                            JOB CATEGORIES
/// =====================================================================
model Category {
  id            String   @id @default(cuid())
  externalId    String   @default(uuid())
  
  // NEW: Discriminator for which pillar this belongs to
  vertical      String   // e.g., "JOBS", "HOUSING", "SOCIAL_SUPPORT"
  
  name          String   
  slug          String   // e.g., "plumbing"
  description   String?
  
  // Hierarchy Logic
  parentId      String?
  parent        Category?  @relation("Subcategories", fields: [parentId], references: [id])
  subcategories Category[] @relation("Subcategories")
  
  // Relationships
  jobPosts         JobPost[]          @relation("MainCategory")
  subCategoryPosts JobPost[]          @relation("SubcategoryPosts")
  serviceOfferings ServiceOffering[]
  supportPrograms  SupportProgram[]
  contractorPricingRules ContractorPricingRule[]
  houseListings    HouseListing[]

  hasSubcategories Boolean @default(false)
  hasParent        Boolean @default(false)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@unique([vertical, slug])
  @@index([vertical])
}


/// =====================================================================
///                            JOB POSTS
/// =====================================================================
model JobPost {
  id          String   @id @default(cuid())
  externalId  String   @default(uuid())
  title       String
  description String
  categoryId  String
  category    Category @relation("MainCategory", fields: [categoryId], references: [id])

  subCategoryId  String?
  subCategory    Category? @relation("SubcategoryPosts", fields: [subCategoryId], references: [id])

  creatorName   String
  accountName   String
  creatorId   String   // The individual user who clicked "Post"
  accountId   String   // The Org or Individual Account owning the post
  jobType     String
  locationCity String
  locationNeighborhood String?
  isRemote   Boolean @default(false)

  requiresDocuments Boolean @default(false)
  requiresEquipment Boolean @default(false)

  allowReferrals    Boolean @default(true) 
  referralBonus     Float?  // If the employer is offering money for a successful referral

  // NEW SOURCE OF TRUTH
  isNegotiable    Boolean @default(false)

  payAmount Float?
  payRate   String?
  skills    String[] @default([])
  experienceLevel String?
  employmentType String?
  documentsNeeded String[] @default([])
  equipmentRequired String[] @default([])
  additionalNotes String?
  status String @default("ACTIVE")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applications JobPostApplication[]
  ratings     Rating[]


  @@index([locationCity])
  @@index([status])
  @@index([creatorId]) // Good for "My Posts" dashboard
  @@index([accountId])
  @@index([categoryId])
}


/// =====================================================================
///                        JOB POST APPLICATIONS
/// =====================================================================
model JobPostApplication {
  id           String   @id @default(cuid())
  externalId   String   @default(uuid())

  // ======================
  // Relations
  // ======================
  jobPostId    String
  jobPost      JobPost  @relation(fields: [jobPostId], references: [id], onDelete: Cascade)

  applicantId  String   // User ID from Identity Service
  employerId   String   // Denormalized for fast dashboard queries

  // ======================
  // Referral Details
  // ======================
  referrerName         String?
  referrerPhone        String?
  referrerEmail        String? // Kept for Formal Pillar background checks
  referrerRelationship String? // e.g., "Former Manager", "Vouched Colleague"

  // ======================
  // Applicant Intent & Compliance
  // ======================
  expectedPay          Float?
  availabilityDate     DateTime?
  availabilityNotes    String?
  
  // Handshake: Worker confirms they have the tools mentioned in JobPost
  hasRequiredEquipment Boolean @default(false) 

  // ======================
  // Status & Decisioning
  // ======================
  status            String    @default("PENDING") 
  employerNotes     String?
  rejectionReason   String?
  agreedPay         Float?    // The final negotiated rate
  agreedStartDate   DateTime?

  // ======================
  // Lifecycle Timestamps
  // ======================
  reviewedAt   DateTime?
  decidedAt    DateTime?
  startedAt    DateTime?
  completedAt  DateTime?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // ======================
  // Relations
  // ======================
  attachments   JobApplicationAttachment[]
  statusHistory JobApplicationStatusHistory[]

  // ======================
  // Constraints & Indexes
  // ======================
  @@unique([jobPostId, applicantId])
  @@index([applicantId])
  @@index([employerId])
  @@index([jobPostId])
  @@index([status])
  @@index([referrerPhone])
  @@index([referrerEmail]) // Added index for referral lookups
}

model JobApplicationAttachment {
  id             String   @id @default(cuid())
  externalId     String   @default(uuid())

  applicationId  String
  application    JobPostApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  // ======================
  // Document Metadata
  // ======================
  type        String
  /*
    CV
    COVER_LETTER
    ID
    CERTIFICATE
    LICENSE
    PORTFOLIO
    OTHER
  */

  fileUrl     String
  fileName    String?
  mimeType    String?
  fileSize    Int?

  // Optional structured text (important!)
  contentText String?
  /*
    Used when:
    - Cover letter is typed, not uploaded
    - Lightweight informal applications
  */

  isPrimary   Boolean @default(false)
  isRequired  Boolean @default(false)

  createdAt   DateTime @default(now())

  @@index([applicationId])
  @@index([type])
}

model JobApplicationStatusHistory {
  id             String   @id @default(cuid())

  applicationId  String
  application    JobPostApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  oldStatus      String
  newStatus      String
  changedBy      String   // User/Admin/Employer ID
  reason         String?

  createdAt      DateTime @default(now())

  @@index([applicationId])
  @@index([newStatus])
}

/// =====================================================================
///                        CONTRACTOR SERVICE OFFERINGS
/// =====================================================================
/// =====================================================================
///                        CONTRACTOR SERVICE OFFERINGS
/// =====================================================================
model ServiceOffering {
  id           String   @id @default(cuid())
  externalId   String   @default(uuid())
  
  // --- EXTERNAL IDENTITY ANCHORS ---
  // refers to the individual human user UUID in Profile DB
  creatorId    String   
  // refers to the root 'Account' (Org or Individual) in Profile DB
  accountId    String   

  // --- DENORMALIZED DISPLAY METADATA ---
  // Store names locally to avoid high-frequency cross-service gRPC calls
  creatorName  String?  
  accountName  String

  // NOTE: 'contractorType' and 'isVerified' are removed.
  // These are handled by the Account model in the Profile Service.
  // The API Gateway/Aggregator will inject these into the response DTO.

  // --- LISTING DETAILS ---
  title        String   
  description  String
  
  // AI Discovery: e.g., ["JOBS", "SOCIAL_SUPPORT"]
  // This allows one listing to appear in multiple marketplace pillars.
  verticals    String[] @default(["JOBS"]) 

  categoryId   String
  category     Category @relation(fields: [categoryId], references: [id])
  
  // --- PRICING & LOGISTICS ---
  basePrice    Float
  priceUnit    String   @default("FIXED") // FIXED, PER_HOUR, PER_SESSION
  currency     String   @default("KES")
  
  locationCity         String
  locationNeighborhood String?
  
  // Snapshot for quick search results & UI rendering
  yearsExperience Int?
  availability    String?  // e.g., JSON string or "Mon-Fri, 8am-5pm"
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // --- RELATIONSHIPS (Internal to Listings DB) ---
  bookings        ServiceBooking[]
  reviews         Rating[] @relation("ServiceReviews")

  // --- INDEXES ---
  @@index([locationCity])
  @@index([verticals])   
  @@index([creatorId])
  @@index([accountId])
  @@index([categoryId])
}

/// =====================================================================
///                           CONTRACTOR SERVICE BOOKINGS
/// =====================================================================
model ServiceBooking {
  id            String   @id @default(cuid())
  externalId    String   @default(uuid())

  // ======================
  // THE WHO (External IDs)
  // ======================
  // The Provider (Individual or Org) from Profile DB
  contractorId  String   
  // The User/Beneficiary from Profile DB
  clientId      String   

  // ======================
  // THE WHAT
  // ======================
  // Link to a specific storefront item (Optional if booking contractor generally)
  serviceId     String?
  service       ServiceOffering? @relation(fields: [serviceId], references: [id])

  // Denormalized for quick display in "My Bookings"
  contractorName String?  
  serviceTitle   String?  

  // ======================
  // THE WHEN & WHERE
  // ======================
  status        String    @default("PENDING") // PENDING | CONFIRMED | COMPLETED | CANCELLED
  scheduledDate DateTime?
  locationCity  String?
  
  // ======================
  // FINANCIALS & NOTES
  // ======================
  agreedPrice   Float?
  currency      String    @default("KES")
  customerNotes String?   // "Please come after 2 PM"
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([contractorId])
  @@index([clientId])
  @@index([status])
  @@index([serviceId])
}

/// =====================================================================
///                           RATINGS & REVIEWS
/// =====================================================================
model Rating {
  id              String           @id @default(cuid())
  externalId      String           @default(uuid())
  
  // Relation to JobPost (Optional, for employer reviews)
  jobPostId       String?
  jobPost         JobPost?         @relation(fields: [jobPostId], references: [id])

  // Relation to ServiceOffering (Optional, for contractor reviews)
  serviceId       String?
  serviceOffering ServiceOffering? @relation("ServiceReviews", fields: [serviceId], references: [id])

  userId          String   // The person writing the review (Reviewer)
  rating          Int      // e.g., 1-5
  review          String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

/// =====================================================================
///                            HOUSING (Asset-Driven)
/// =====================================================================
model HouseListing {
  id           String   @id @default(cuid())
  externalId   String   @default(uuid())
  creatorId      String   // The individual User UUID
  creatorName    String
  accountId    String   // The owning Account (Individual or Property Agency Org)
  accountName   String
  
  title        String
  description  String

  // UPDATED: Use Category relation instead of a raw String type
  categoryId   String
  category     Category @relation(fields: [categoryId], references: [id])
  
  // Optional: Keep 'type' if you want a secondary label, 
  // but Category is now the source of truth for the pillar
  listingType  String   // e.g., "RENTAL", "SALE"
  
  price        Float
  currency     String   @default("KES")
  
  // Property details
  bedrooms     Int?
  bathrooms    Int?
  amenities    String[] @default([])
  isFurnished  Boolean  @default(false)
  
  // Location
  locationCity         String
  locationNeighborhood String?
  address              String?
  
  status       String   @default("AVAILABLE") // e.g., AVAILABLE, BOOKED, SOLD
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relationships
  images       HouseImage[]
  viewings     HouseViewing[]

  @@index([locationCity, listingType, categoryId])
  @@index([creatorId])
  @@index([accountId])
  @@index([status])
}

model HouseImage {
  id           String       @id @default(cuid())
  url          String
  isMain       Boolean      @default(false)
  houseId      String
  house        HouseListing @relation(fields: [houseId], references: [id])
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt  
}

model HouseViewing {
  id           String       @id @default(cuid())
  houseId      String
  house        HouseListing @relation(fields: [houseId], references: [id])
  viewerId     String       // User ID
  viewingDate  DateTime
  notes        String?
  bookedById   String       // User ID who booked the viewing
  status       String       @default("SCHEDULED")
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt  
}

/// =====================================================================
///                       SOCIAL SUPPORT (Impact-Driven)
/// =====================================================================
model SupportProgram {
  id           String   @id @default(cuid())
  externalId   String   @default(uuid())

  // --- IDENTITY ANCHORS ---
  // accountId refers to the root 'Account' (Individual or Organization) in Profile DB
  accountId      String   
  // creatorId refers to the specific human staff member/user who created this listing
  creatorId      String   

  // --- DENORMALIZED IDENTITY (For fast UI rendering) ---
  // Store the name of the NGO/Provider to avoid cross-service joins on every list view
  accountName    String
  creatorName    String?

  // Note: 'providerType' and 'isVerified' are removed here.
  // These are fetched/injected from the Account model in the Profile Service.

  title        String
  description  String

  // --- CATEGORIZATION ---
  categoryId    String
  category      Category @relation(fields: [categoryId], references: [id])

  // Marketplace Discovery: e.g., "GRANT", "TRAINING", "FOOD_STAMP", "MENTORSHIP"
  supportType   String   @default("GENERAL")

  /// =====================================================
  /// ELIGIBILITY & TARGETING
  /// =====================================================
  eligibilityCriteria String?
  targetAudience      String[] @default([]) 
  
  // Handshake Requirements: Pre-conditions for the application process
  requiresIdVerification Boolean @default(false)
  requiresIncomeProof    Boolean @default(false)

  /// =====================================================
  /// COST & ACCESS
  /// =====================================================
  isFree     Boolean @default(true)
  baseCost   Float?  @default(0) 
  currency   String  @default("KES")

  /// =====================================================
  /// CAPACITY & IMPACT TRACKING
  /// =====================================================
  maxBeneficiaries     Int?      // Total available slots
  currentBeneficiaries Int       @default(0) // Successful approvals count
  
  // Financial Transparency: For sponsored/grant-based programs
  totalBudget          Float?    // Total funding allocated
  remainingBudget      Float?    // Funds left to disburse

  locationCity         String?
  locationNeighborhood String?

  /// =====================================================
  /// LIFECYCLE & METRICS
  /// =====================================================
  // DRAFT | ACTIVE | PAUSED | COMPLETED | ARCHIVED
  status    String    @default("DRAFT") 
  isActive  Boolean   @default(true)
  expiresAt DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // RELATIONS
  applications SupportApplication[]
  milestones   SupportMilestone[]

  // INDEXES: Optimized for Marketplace Search & Discovery
  @@index([categoryId])
  @@index([locationCity])
  @@index([status])
  @@index([accountId])
  @@index([supportType])
}

model SupportApplication {
  id           String         @id @default(cuid())
  externalId   String         @default(uuid())
  
  programId    String
  program      SupportProgram @relation(fields: [programId], references: [id])
  
  beneficiaryId String        // The User UUID from Identity Service
  
  // Status Management: Matches the lifecycle of an "Opportunity"
  status       String         @default("PENDING") 
  // PENDING | UNDER_REVIEW | WAITLISTED | APPROVED | REJECTED | DISBURSED | CLOSED
  
  /// =====================================================
  /// BENEFICIARY SUBMISSION
  /// =====================================================
  statementOfNeed String?     
  requestedValue  Float?      // What the user is asking for (if variable)
  
  /// =====================================================
  /// REVIEW & AUDIT (The NGO/Provider side)
  /// =====================================================
  internalNGOAudit String?    // Private internal notes (Transparency for Admin)
  rejectionReason  String?
  reviewedById     String?    // UUID of the staff member who made the decision

  // Final Award Logic: The result of the "Connection"
  awardedAmount   Float?      // Final approved financial grant
  awardedQuantity Int?        // Final approved physical units (e.g., 2 bags of maize)
  awardedDetails  String?     // Description (e.g., "Full Scholarship covering Tuition")

  /// =====================================================
  /// HANDSHAKE & COMPLIANCE
  /// =====================================================
  // Tracks if the user has completed the program's requirements (e.g., ID check)
  isComplianceVerified Boolean @default(false)
  
  // Handshake: Beneficiary acknowledges the terms of the support
  termsAccepted        Boolean @default(false)
  acceptedAt           DateTime?

  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  // RELATIONS
  benefits      SupportBenefit[] 
  documents     SupportDocument[]

  // CONSTRAINTS
  @@unique([programId, beneficiaryId]) // Prevents "Double Dipping" (Anti-fraud)
  @@index([beneficiaryId])
  @@index([status])
  @@index([programId])
}

model SupportBenefit {
  id              String             @id @default(cuid())
  applicationId   String
  application     SupportApplication @relation(fields: [applicationId], references: [id])
  
  // Snapshotted from the program to ensure historical audit integrity
  // e.g., "CASH_TRANSFER", "FOOD_BASKET", "VOUCHER", "EQUIPMENT"
  type            String             
  
  value           Float?             // Monetary value (e.g., 5000.00)
  quantity        Int?               @default(1) // For physical goods
  description     String?            // e.g., "January 2026 Stipend" or "Solar Lamp Kit"
  
  // Lifecycle: PENDING -> DISBURSED -> RECEIVED -> FAILED
  status          String             @default("PENDING") 
  
  /// =====================================================
  /// THE HANDSHAKE (Anti-Fraud Pillar)
  /// =====================================================
  confirmedByUser Boolean            @default(false)     // True only when beneficiary clicks "Confirm"
  confirmedAt     DateTime?
  
  // Optional: Reference to an external transaction (M-Pesa ID, Bank Ref, etc.)
  // This supports your Phase 2 Financial Integration goals.
  externalReference String?          @unique 

  /// =====================================================
  /// LOGISTICS & AUDIT
  /// =====================================================
  disbursedAt     DateTime?          // When the NGO sent the benefit
  receivedAt      DateTime?          // When the user actually got it
  
  createdAt       DateTime           @default(now())

  @@index([applicationId])
  @@index([status])
  @@index([externalReference])
}

model SupportDocument {
  id              String             @id @default(cuid())
  externalId      String             @default(uuid())
  
  applicationId   String
  application     SupportApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  
  // Document Classification
  // ID_CARD | INCOME_PROOF | DISABILITY_CERT | RESIDENCY_LETTER | ACADEMIC_CERT
  documentType    String             
  
  fileUrl         String             // S3/Cloud Storage link
  fileName        String?            // Original name (e.g., "ID_Front.jpg")
  
  // Verification Workflow
  isVerified      Boolean            @default(false)
  verifiedAt      DateTime?
  verifiedBy      String?            // Admin/Staff User UUID who approved the doc
  rejectionReason String?            // If verification fails, why?

  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([applicationId])
  @@index([documentType])
}

model SupportMilestone {
  id          String         @id @default(cuid())
  externalId  String         @default(uuid())
  
  programId   String
  program     SupportProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  
  title       String         // e.g., "Orientation Meeting" or "Week 1 Skills Assessment"
  description String?
  
  // Sequencing
  order       Int            @default(0)
  
  // Required for Completion?
  isRequired  Boolean        @default(true)

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([programId])
}

model ContractorPricingRule {
  id                   String   @id @default(uuid())
  vertical             String   
  unit                 String   

  // 1. Replace categorySlug string with categoryId
  categoryId           String?

  // 2. Define the relation with onDelete: Cascade
  // This ensures if a Category is deleted, these rules are also removed automatically.
  category             Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  // ISO 4217 Currency Code (e.g., KES, USD, NGN)
  currency             String   @default("KES")

  minPrice             Float?   @default(0)
  maxPrice             Float?   
  isExperienceRequired Boolean  @default(false)
  isNotesRequired      Boolean  @default(false)
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())

  // 3. Update the unique constraint to use the ID
  @@unique([vertical, unit, currency, categoryId])
}

