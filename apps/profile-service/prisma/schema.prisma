generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// --- GLOBAL WRAPPER (The Root Anchor) ---
model Account {
  id          String   @id @default(cuid())
  uuid        String   @unique @default(uuid())
  accountCode String   @unique

  // Individual: "John Doe" | Organization: "Pivota NGO"
  name        String?
  type        String   @default("INDIVIDUAL") // INDIVIDUAL | ORGANIZATION

  // --- THE TRUST ANCHOR ---
  // The master flag used for gRPC/JWT and UI badges
  isVerified  Boolean  @default(false)
  
  // List of verified capabilities (e.g., ["IDENTITY", "KRA", "PRO_LICENSE"])
  verifiedFeatures String[]

  // Relation to the verification lifecycle and documents
  verifications AccountVerification[]

  organization Organization?
  contractor   ContractorProfile?
  users        User[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- NEW: ACCOUNT VERIFICATION TRACKER ---
model AccountVerification {
  id          String   @id @default(cuid())
  accountId   String
  account     Account  @relation(fields: [accountId], references: [uuid], onDelete: Cascade)

  // e.g., "NATIONAL_ID", "BUSINESS_REGISTRATION", "KRA_PIN", "LICENSE"
  type        String   
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED, EXPIRED
  
  // URL to the uploaded evidence (ID photo, PDF Certificate, etc.)
  documentUrl String?
  
  rejectionReason String?
  verifiedAt      DateTime?
  expiresAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([accountId, type])
}



// --- ENTITY LAYER (Independent Business Profile) ---
model Organization {
  id      String @id @default(cuid())
  uuid    String @unique @default(uuid())
  orgCode String @unique
  name    String

  accountId String  @unique
  account   Account @relation(fields: [accountId], references: [uuid], onDelete: Cascade)

  profile    OrganizationProfile?
  completion ProfileCompletion?
  members    OrganizationMember[]

  // Inherited/Synced from Account.isVerified
  verificationStatus String   @default("PENDING") 
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

// --- IDENTITY LAYER (Logins/Humans) ---
model User {
  id       String  @id @default(cuid())
  uuid     String  @unique @default(uuid())
  userCode String  @unique
  email    String  @unique
  phone    String? @unique

  firstName String?
  lastName  String?

  accountId String
  account   Account @relation(fields: [accountId], references: [uuid], onDelete: Cascade)

  roleName     String  @default("GeneralUser")
  profileImage String?

  profile     UserProfile?
  completion  ProfileCompletion?
  memberships OrganizationMember[]

  status    String   @default("ACTIVE")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- PROFILE COMPLETION TRACKER ---
model ProfileCompletion {
  id String @id @default(cuid())

  userUuid String? @unique
  user     User?   @relation(fields: [userUuid], references: [uuid], onDelete: Cascade)

  organizationUuid String?       @unique
  organization     Organization? @relation(fields: [organizationUuid], references: [uuid], onDelete: Cascade)

  percentage    Int      @default(0) 
  missingFields String[] 
  isComplete    Boolean  @default(false)

  updatedAt DateTime @updatedAt
}

// --- ACCESS LAYER (Team Connectivity) ---
model OrganizationMember {
  id               String       @id @default(cuid())
  userUuid         String
  user             User         @relation(fields: [userUuid], references: [uuid], onDelete: Cascade)
  organizationUuid String
  organization     Organization @relation(fields: [organizationUuid], references: [uuid], onDelete: Cascade)

  roleName String

  @@unique([userUuid, organizationUuid])
}

// --- PROFILE LAYER (Human Metadata) ---
model UserProfile {
  id           String    @id @default(cuid())
  userUuid     String    @unique
  user         User      @relation(fields: [userUuid], references: [uuid], onDelete: Cascade)
  profileImage String? 
  bio          String?
  gender       String?
  dateOfBirth  DateTime?
  nationalId   String?   @unique
}

// --- LOOKUP TABLE FOR ORGANIZATION TYPES ---
// Seed this table in your Profile Microservice
model OrganizationType {
  id    String @id @default(cuid())
  slug  String @unique // e.g., "NGO", "PRIVATE_LIMITED", "SOLE_PROPRIETORSHIP"
  label String // e.g., "Non-Governmental Organization"

  // Relation back to profiles
  profiles OrganizationProfile[]

  createdAt DateTime @default(now())
}


// --- BUSINESS PROFILE LAYER (Entity Metadata) ---
model OrganizationProfile {
  id               String       @id @default(cuid())
  organizationUuid String       @unique
  organization     Organization @relation(fields: [organizationUuid], references: [uuid], onDelete: Cascade)

  // --- UPDATED RELATION ---
  // We link via the slug for better readability in gRPC/Logs
  typeSlug         String?      
  type             OrganizationType? @relation(fields: [typeSlug], references: [slug], onUpdate: Cascade) 
  
  about          String?
  website        String?
  officialEmail  String?
  officialPhone  String?
  registrationNo String? @unique
  kraPin         String? @unique
  logo           String?
  physicalAddress String?
}


// --- CONTRACTOR PROFILE ---
model ContractorProfile {
  id               String       @id @default(cuid())
  uuid             String       @unique @default(uuid())
  
  accountId        String       @unique
  account          Account      @relation(fields: [accountId], references: [uuid], onDelete: Cascade)

  specialties      String[]     
  serviceAreas     String[]     
  
  yearsExperience  Int?         @default(0)
  
  // Snapshot from Account.isVerified for fast querying in search
  isVerified       Boolean      @default(false)
  
  averageRating    Float        @default(0.0)
  totalReviews     Int          @default(0)

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
}

